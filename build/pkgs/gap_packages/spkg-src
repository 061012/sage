#!/usr/bin/env bash

if [ $# -ne 0 ]; then
    UPSTREAM_SOURCE_TARBALL=$1
    echo "Using $UPSTREAM_SOURCE_TARBALL instead of downloading tarball"
fi

SPKG_ROOT=`pwd`

set -e
shopt -s extglob

# Remove old sources and download new
rm -rf src
if [ -z "$UPSTREAM_SOURCE_TARBALL" ]; then
    tar xjf <( curl ftp://ftp.gap-system.org/pub/gap/gap46/tar.bz2/gap4r6p5_2013_07_20-20_02.tar.bz2 )
else
    tar xjf "$UPSTREAM_SOURCE_TARBALL"
fi
GAP=`pwd`/gap4r6

# Make everything writable
chmod -R u+w "$GAP"


mkdir src
for pkg in \
    crime ctbllib design factint grape \
    guava Hap HAPcryst laguna polymaking \
    sonata toric polycyclic autpgrp Alnuth
do
    echo "Copying package $pkg"
    pkg_dir=`ls -d "$GAP/pkg/$pkg"*`
    pkg_lower=`echo $pkg | tr [:upper:] [:lower:]`
    cp -rap "$pkg_dir" src/
    cp -p "$GAP/pkg/README.$pkg_lower" src/
done

rm -rf "$GAP"


# tar cjf gap_packages-4.6.5.tar.bz2 src/  && rm -rf src/
