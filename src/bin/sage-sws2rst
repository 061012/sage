#!/usr/bin/env python
# -*- coding: utf-8 -*-

import sys
import tarfile
import os
import shutil
import codecs
import tempfile
from sagenb.misc.worksheet2rst import worksheet2rst

def process_sws(file_name):

    sws_file = tarfile.open(file_name, mode='r:bz2')
    #TODO: python complains about using tempnam, but I don't
    #know hot to fix it or see any danger
#    tempname = os.tempnam('.')
    tempname = os.path.join(tempfile.gettempdir(), file_name)
    sws_file.extractall(tempname)
    base_name = os.path.split(os.path.splitext(file_name)[0])[1]
    base_name_clean = base_name.replace(' ','_')

    #Images
    images_dir = base_name_clean + '_media'
    if not os.path.exists(images_dir):
        os.mkdir(images_dir)

    #"data" dir
    data_path = os.path.join(tempname,'sage_worksheet','data')
    if os.path.exists(data_path):
        for image in os.listdir(data_path):
            try:
                shutil.move(os.path.join(data_path, image), os.path.join(images_dir, image.replace(' ','_')))
            except shutil.Error:
                pass

    #cells
    cells_path = os.path.join(tempname,'sage_worksheet','cells')
    for cell in os.listdir(cells_path):
        cell_path = os.path.join(cells_path, cell)
        for image in os.listdir(cell_path):
            shutil.copy2(os.path.join(cell_path, image),
                         os.path.join(images_dir, 'cell_%s_%s'%(cell,image)))

    #read html file, parse it, write rst file
    file = codecs.open(os.path.join('.',tempname,'sage_worksheet','worksheet.html'),
                          mode='r',
                          encoding='utf-8')
    html_text = file.read()
    file.close()
    rst_text = worksheet2rst(html_text, images_dir = images_dir)
    rst_file = base_name_clean + '.rst'
    out_file = codecs.open(rst_file, mode='w',
                  encoding='utf-8')
    out_file.write(rst_text)
    out_file.close()

    shutil.rmtree(tempname)

if __name__=='__main__':
    if len(sys.argv)<=1:
        print 'First argument should be a sws file'
        sys.exit()
    for file_name in sys.argv[1:]:
        print file_name
        process_sws(file_name)


